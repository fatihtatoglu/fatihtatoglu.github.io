<!DOCTYPE html><html lang="en"><head><base href="https://blog.tatoglu.net/"><meta charset="UTF-8"><meta name="yandex-verification" content="31a29a16b97b37a8"><meta name="msvalidate.01" content="578B5091D7C5A2C03BE2EE0DF0CCC024"><meta name="google-site-verification" content="Ovuv1WWfkBGnFfpFHwwPPQSv274GrePTq1hq1Oq0Xc8"><link rel="profile" href="https://gmpg.org/xfn/11"><meta name="description" content="Set up HAProxy on CentOS 7.X for efficient load balancing. Follow step-by-step instructions for preparation, installation, configuration, and security. Ensure a smooth deployment."><meta name="author" content="Fatih Tatoƒülu"><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap&v=8e74655158b343b60637f8d9173717c5" rel="stylesheet"><link rel="canonical" href="https://blog.tatoglu.net/en/lab/haproxy/cluster.html"><link rel="alternate" hreflang="x-default" href="https://blog.tatoglu.net/lab/haproxy/cluster.html"><link rel="alternate" hreflang="tr" href="https://blog.tatoglu.net/lab/haproxy/cluster.html"><link rel="alternate" hreflang="en" href="https://blog.tatoglu.net/en/lab/haproxy/cluster.html"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fatih Tatoƒülu - Cluster</title><link rel="stylesheet" href="https://blog.tatoglu.net/css/main.css?v=8e74655158b343b60637f8d9173717c5"><link rel="stylesheet" href="https://blog.tatoglu.net/css/custom.css?v=8e74655158b343b60637f8d9173717c5"><link rel="apple-touch-icon" sizes="180x180" href="https://blog.tatoglu.net/image/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://blog.tatoglu.net/image/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://blog.tatoglu.net/image/favicon/favicon-16x16.png"><link rel="manifest" href="https://blog.tatoglu.net/image/favicon/site.webmanifest"><link rel="icon" href="https://blog.tatoglu.net/favicon.ico" type="image/x-icon"><link rel="shortcut icon" href="https://blog.tatoglu.net/favicon.ico" type="image/x-icon"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@fatihtatoglu"><meta name="twitter:title" content="Cluster"><meta name="twitter:description" content="Set up HAProxy on CentOS 7.X for efficient load balancing. Follow step-by-step instructions for preparation, installation, configuration, and security. Ensure a smooth deployment."><script type="application/ld+json">{"@context": "https://schema.org","@graph": [{"@type": "WebSite","@id": "https://blog.tatoglu.net/#website","url": "https://blog.tatoglu.net/","name": "Fatih Tatoƒülu","description": "Fatih Tatoƒülu - Ki≈üisel Web Sayfasƒ±","publisher": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"inLanguage": ""},{"@type": "WebPage","@id": "https://blog.tatoglu.net/en/lab/haproxy/cluster.html/#webpage","url": "https://blog.tatoglu.net/en/lab/haproxy/cluster.html","name": "Cluster - Fatih Tatoƒülu","isPartOf": {"@id": "https://blog.tatoglu.net/#website"},"datePublished": "2022-06-12T18:41:00+0000","breadcrumb": {"@id": "https://blog.tatoglu.net/en/lab/haproxy/cluster.html/#breadcrumb"},"inLanguage": "","potentialAction": [{"@type": "ReadAction","target": ["https://blog.tatoglu.net/en/lab/haproxy/cluster.html"]}]},{"@type": "BreadcrumbList","@id": "https://blog.tatoglu.net/en/lab/haproxy/cluster.html/#breadcrumb","itemListElement": [{"@type": "ListItem","position": 1,"name": "Ana sayfa","item": "https://blog.tatoglu.net/"},{"@type": "ListItem","position": 2,"name": "Cluster"}]},{"@type": "Article","@id": "https://blog.tatoglu.net/en/lab/haproxy/cluster.html/#article","isPartOf": {"@id": "https://blog.tatoglu.net/en/lab/haproxy/cluster.html/#webpage"},"author": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"headline": "Cluster","datePublished": "2022-06-12T18:41:00+0000","mainEntityOfPage": {"@id": "https://blog.tatoglu.net/en/lab/haproxy/cluster.html/#webpage"},"publisher": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"articleSection": ["lab"],"keywords": ["haproxy","keepalived","centos","failover","high availability"],"inLanguage": ""},{"@type": ["Person"],"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034","name": "Fatih Tatoƒülu","url": "https://blog.tatoglu.net/about-me.html","image": {"@type": "ImageObject","@id": "https://blog.tatoglu.net/#personlogo","inLanguage": "","url": "https://blog.tatoglu.net/image/about_me.jpg","contentUrl": "https://blog.tatoglu.net/image/about_me.jpg","width": 1024,"height": 683,"caption": "Fatih Tatoƒülu"},"address": {"@type": "PostalAddress","addressLocality": "ƒ∞stanbul","addressCountry": "Turkey"},"email": "fatih@tatoglu.net"}]}</script></head><body><header><h1 id="title">Cluster</h1><summary></summary></header><nav><i class="menu-icon">&#9776;</i><ul><li><a href="https://blog.tatoglu.net/en/index.html">Home Page</a></li><li><a href="https://blog.tatoglu.net/en/coaching/index.html">Coaching</a></li><li><a href="https://blog.tatoglu.net/en/my-notes/index.html">My Notes</a></li><li><a href="https://blog.tatoglu.net/en/lab/index.html">Laboratory</a></li><li><a href="https://blog.tatoglu.net/en/about-me.html">About Me</a></li><li><button id="btnFeedback" class="icon feedback" title="Feedback">&nbsp;</button> <button id="btnDarkTheme" class="icon dark-theme" title="Dark Theme">&nbsp;</button> <button id="btnLightTheme" class="icon light-theme" title="Light Theme">&nbsp;</button> <button id="btnTurkish" class="icon turkish" title="Turkish">&nbsp;</button></li></ul></nav><main><section><strong>HAProxy</strong><ul><li><a href=".&#x2F;en&#x2F;lab&#x2F;haproxy&#x2F;setup.html">Setup</a></li><li class="active">Cluster</li><li><a href=".&#x2F;en&#x2F;lab&#x2F;haproxy&#x2F;default-routing.html">Static Routing</a></li><li><a href=".&#x2F;en&#x2F;lab&#x2F;haproxy&#x2F;ssl-certificate.html">SSL Certificate</a></li></ul></section><article><p>This note contains a cluster setup that has two HAProxy servers.</p><p>üî• This note is written for KeepAlived 2.2.7 version. Newer versions may have different configurations.</p><h2>Preliminary Preparation</h2><table><thead><tr><th align="right">Property</th><th align="left">Master Server</th><th align="left">Slave Server</th></tr></thead><tbody><tr><td align="right"><strong>Server Name</strong></td><td align="left">haproxy-01</td><td align="left">haproxy-02</td></tr><tr><td align="right"><strong>IP Address</strong></td><td align="left">172.19.85.102</td><td align="left">172.19.85.103</td></tr><tr><td align="right"><strong>Netmask</strong></td><td align="left">255.255.255.0</td><td align="left">255.255.255.0</td></tr><tr><td align="right"><strong>Gateway</strong></td><td align="left">172.19.85.1</td><td align="left">172.19.85.1</td></tr><tr><td align="right"><strong>CPU</strong> ‚≠ê</td><td align="left">4</td><td align="left">4</td></tr><tr><td align="right"><strong>Memory</strong> ‚≠ê</td><td align="left">2 GB</td><td align="left">2 GB</td></tr><tr><td align="right"><strong>Disk</strong></td><td align="left">40GB</td><td align="left">40 GB</td></tr><tr><td align="right"><strong>OS</strong></td><td align="left">CentOS 7.X Minimal</td><td align="left">CentOS 7.X Minimal</td></tr><tr><td align="right"><strong>Internet Access</strong></td><td align="left">Yes</td><td align="left">Yes</td></tr></tbody></table><p>‚≠ê: You can increase the resources during the installation process.</p><p>There is no need to have a <strong>root</strong> user during the setup and build process. However, a user with root privileges will be needed. In the note, the <strong>devops</strong> user is used for the setup and build process. If you have a different user, please use that.</p><p>Moreover, the cluster needs a dedicated IP address to serve the master node. So, in this note, the <code>172.19.85.104</code> will be used as a virtual IP address.</p><h2>Setup Preparation</h2><p>The following file should be downloaded and extracted in the first server.</p><pre><code class="language-shell">devops@haproxy-01:~$ curl https://www.keepalived.org/software/keepalived-2.2.7.tar.gz &gt; keepalived-2.2.7.tar.gz

devops@haproxy-01:~$ tar xf keepalived-2.2.7.tar.gz
</code></pre><p>The following file should be downloaded and extracted in the second server.</p><pre><code class="language-shell">devops@haproxy-02:~$ curl https://www.keepalived.org/software/keepalived-2.2.7.tar.gz &gt; keepalived-2.2.7.tar.gz

devops@haproxy-02:~$ tar xf keepalived-2.2.7.tar.gz
</code></pre><h2>Build</h2><p>The build process is automatic and needs to run the below commands in the master and slave servers.</p><pre><code class="language-shell">devops@haproxy-01:~$ cd ~
devops@haproxy-01:~$ sudo su
root@haproxy-01:/home/devops# 
root@haproxy-01:/home/devops# cd keepalived-2.2.7
root@haproxy-01:/home/devops# ./configure --prefix=/
root@haproxy-01:/home/devops# make
root@haproxy-01:/home/devops# make install
root@haproxy-01:/home/devops# exit
devops@haproxy-01:~$
</code></pre><pre><code class="language-shell">devops@haproxy-02:~$ cd ~
devops@haproxy-02:~$ sudo su
root@haproxy-02:/home/devops# 
root@haproxy-02:/home/devops# cd keepalived-2.2.7
root@haproxy-02:/home/devops# ./configure --prefix=/
root@haproxy-02:/home/devops# make
root@haproxy-02:/home/devops# make install
root@haproxy-02:/home/devops# exit
devops@haproxy-02:~$
</code></pre><h2>Configuration</h2><p>Before starting with the configuration section, the KeepAlived library&#39;s working style should be understood. The library listens to the master and slave nodes at the same time. If the master node faces problems, it updates the slave node&#39;s IP address with the virtual IP address. When the master node is again alive or available, the library updates the master node&#39;s IP address. To do this, the library needs a failover script.</p><h3>Failover Script</h3><p>The failover script checks the haproxy service status. The script must be added to all the servers.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo vi /usr/local/bin/failover.sh
</code></pre><pre><code class="language-bash">#!/bin/shell
SERVICE=&#39;haproxy&#39;
STATUS=$(ps ax | grep -v grep | grep $SERVICE)

if [ &quot;$STATUS&quot; != &quot;&quot; ]
then
    exit 0
else
    exit 1
fi
</code></pre><p>The KeepAlived library runs with root privileges, so the failover script must be updated its privileges.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo chmod a+rx /usr/local/bin/failover.sh
</code></pre><p>Let&#39;s continue with the configuration of the servers. The master and slave nodes&#39; configurations are different. They are shared below.</p><h3>Master Server</h3><pre><code class="language-shell">devops@haproxy-01:~$ sudo vi /etc/keepalived/keepalived.conf
</code></pre><pre><code class="language-roboconf">global_defs {
     enable_script_security
     smtp_server 127.0.0.1
     smtp_connect_timeout 30
     notification_email {
          fatih@tatoglu.net
     }
}

vrrp_script chk_haproxy {
     script &quot;/usr/local/bin/failover.sh&quot;
     interval 1
     weight 2
     rise 2
     fall 2
     init_fail
}

vrrp_instance VI_MASTER { 
    state MASTER 
    interface eth0
    virtual_router_id 51
    priority 101 
    advert_int 1
    virtual_ipaddress {
        172.19.85.104
    }
    track_script {
        chk_haproxy
    }
    smtp_alert true
}
</code></pre><p>After adding the configuration file to validate it, the below command can be used.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo keepalived --config-test=keepalived.conf
</code></pre><h3>Slave Server</h3><pre><code class="language-shell">devops@haproxy-02:~$ sudo vi /etc/keepalived/keepalived.conf
</code></pre><pre><code class="language-roboconf">global_defs {
     enable_script_security
     smtp_server 127.0.0.1
     smtp_connect_timeout 30
     notification_email {
          fatih@tatoglu.net
     }
}

vrrp_script chk_haproxy {
     script &quot;/usr/local/bin/failover.sh&quot;
     interval 1
     weight 2
     rise 2
     fall 2
     init_fail
}

vrrp_instance VI_BACKUP {
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    virtual_ipaddress {
        172.19.85.104
    }
    track_script {
        chk_haproxy
    }
    smtp_alert true
}
</code></pre><p>After adding the configuration file to validate it, the below command can be used.</p><pre><code class="language-shell">devops@haproxy-02:~$ sudo keepalived --config-test=keepalived.conf
</code></pre><h2>Security</h2><p>If you remember, the firewall is already arranged for the HAProxy. Now, the below command should be beneficial to permit the KeepAlived library.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo firewall-cmd --add-rich-rule=&#39;rule protocol value=&quot;vrrp&quot; accept&#39; --permanent
devops@haproxy-01:~$ sudo firewall-cmd --reload
</code></pre><pre><code class="language-shell">devops@haproxy-02:~$ sudo firewall-cmd --add-rich-rule=&#39;rule protocol value=&quot;vrrp&quot; accept&#39; --permanent
devops@haproxy-02:~$ sudo firewall-cmd --reload
</code></pre><h2>Turning Key</h2><pre><code class="language-shell">devops@haproxy-01:~$ sudo chkconfig keepalived on
devops@haproxy-01:~$ sudo systemctl enable keepalived
devops@haproxy-01:~$ sudo systemctl start keepalived
</code></pre><pre><code class="language-shell">devops@haproxy-02:~$ sudo chkconfig keepalived on
devops@haproxy-02:~$ sudo systemctl enable keepalived
devops@haproxy-02:~$ sudo systemctl start keepalived
</code></pre><h2>Validation</h2><p>First of all, all the servers must be tested individually. For this;</p><ol><li><code>http://172.19.85.102:1985/stats</code></li><li><code>http://172.19.85.103:1985/stats</code></li></ol><p>the above addresses should be visited over the browser. The status page of the HAProxy services must be shown.</p><p>Next, the <code>http://172.19.85.104:1985/stats</code> address should be visited over the browser and the master server&#39;s status page must be shown.</p><p>So far, everything seems okay, if any problems didn&#39;t occur. In the next step, let&#39;s play with the HAProxy service status.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo systemctl stop haproxy
</code></pre><p>With the above command, the HAProxy service on the master server is turned off.After visiting the <code>http://172.19.85.104:1985/stats</code> address again, the expectation is the slave&#39;s status page is shown.</p><p>Finally, when the below command runs, everything should be in the initial state.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo systemctl start haproxy
</code></pre><p>By the way, if you check the configuration files, you can see an email address. So, after every failover status changes, you receive an email. Please don&#39;t forget to update the email address. Otherwise, my email may be locked.</p></article></main><footer>&copy; 1985 - <a href="en/about-me.html" rel="noopener noreferrer" target="_blank">Fatih Tatoƒülu</a></footer><script src="https://blog.tatoglu.net/js/main.js?v=8e74655158b343b60637f8d9173717c5"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-GSVKFRLFNV&v=8e74655158b343b60637f8d9173717c5"></script><script src="https://blog.tatoglu.net/js/analytics.js?v=8e74655158b343b60637f8d9173717c5"></script><div id="pnlFeedbackSurvey"><div class="model-content"><button id="btnFeedbackSurveyClose" class="icon bold x-small">&times;</button><iframe src="https://docs.google.com/forms/d/e/1FAIpQLSewJ_x10HBlFs2lO2zHUBI3ZeSdEXaISpK292RPJBoZyeC1HA/viewform?embedded=true" frameborder="0" marginheight="0" marginwidth="0">Loading‚Ä¶</iframe></div></div></body></html>