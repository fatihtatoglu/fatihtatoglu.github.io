<!DOCTYPE html><html lang="tr"><head><base href="https://blog.tatoglu.net/"><meta charset="UTF-8"><meta name="yandex-verification" content="31a29a16b97b37a8"><meta name="msvalidate.01" content="578B5091D7C5A2C03BE2EE0DF0CCC024"><meta name="google-site-verification" content="Ovuv1WWfkBGnFfpFHwwPPQSv274GrePTq1hq1Oq0Xc8"><link rel="profile" href="https://gmpg.org/xfn/11"><meta name="description" content="HAProxy'nin CentOS üzerinde cluster olarak kurulmasını anlatan notlarım."><meta name="author" content="Fatih Tatoğlu"><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><link rel="canonical" href="https://blog.tatoglu.net/kendime-notlar/haproxy.html"><link rel="alternate" hreflang="x-default" href="https://blog.tatoglu.net/kendime-notlar/haproxy.html"><link rel="alternate" hreflang="tr" href="https://blog.tatoglu.net/kendime-notlar/haproxy.html"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fatih Tatoğlu - HAProxy</title><link rel="stylesheet" href="https://blog.tatoglu.net/css/main.css?v=b76e60534535b24a259cb8d0ae6e8f83"><link rel="stylesheet" href="https://blog.tatoglu.net/css/custom.css?v=b76e60534535b24a259cb8d0ae6e8f83"><link rel="stylesheet" href="https://blog.tatoglu.net/css/3024.css?v=b76e60534535b24a259cb8d0ae6e8f83"><script src="https://blog.tatoglu.net/js/main.js?v=b76e60534535b24a259cb8d0ae6e8f83"></script><script src="https://blog.tatoglu.net/js/analytics.js?v=b76e60534535b24a259cb8d0ae6e8f83"></script><link rel="apple-touch-icon" sizes="180x180" href="https://blog.tatoglu.net/image/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://blog.tatoglu.net/image/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://blog.tatoglu.net/image/favicon/favicon-16x16.png"><link rel="manifest" href="https://blog.tatoglu.net/image/favicon/site.webmanifest"><link rel="icon" href="https://blog.tatoglu.net/favicon.ico" type="image/x-icon"><link rel="shortcut icon" href="https://blog.tatoglu.net/favicon.ico" type="image/x-icon"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@fatihtatoglu"><meta name="twitter:title" content="HAProxy"><meta name="twitter:description" content="HAProxy'nin CentOS üzerinde cluster olarak kurulmasını anlatan notlarım."><script type="application/ld+json">{"@context": "https://schema.org","@graph": [{"@type": "WebSite","@id": "https://blog.tatoglu.net/#website","url": "https://blog.tatoglu.net/","name": "Fatih Tatoğlu","description": "Fatih Tatoğlu - Kişisel Web Sayfası","publisher": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"inLanguage": ""},{"@type": "WebPage","@id": "https://blog.tatoglu.net/kendime-notlar/haproxy.html/#webpage","url": "https://blog.tatoglu.net/kendime-notlar/haproxy.html","name": "HAProxy - Fatih Tatoğlu","isPartOf": {"@id": "https://blog.tatoglu.net/#website"},"datePublished": "2022-05-28T18:49:21+0000","breadcrumb": {"@id": "https://blog.tatoglu.net/kendime-notlar/haproxy.html/#breadcrumb"},"inLanguage": "","potentialAction": [{"@type": "ReadAction","target": ["https://blog.tatoglu.net/kendime-notlar/haproxy.html"]}]},{"@type": "BreadcrumbList","@id": "https://blog.tatoglu.net/kendime-notlar/haproxy.html/#breadcrumb","itemListElement": [{"@type": "ListItem","position": 1,"name": "Ana sayfa","item": "https://blog.tatoglu.net/"},{"@type": "ListItem","position": 2,"name": "HAProxy"}]},{"@type": "Article","@id": "https://blog.tatoglu.net/kendime-notlar/haproxy.html/#article","isPartOf": {"@id": "https://blog.tatoglu.net/kendime-notlar/haproxy.html/#webpage"},"author": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"headline": "HAProxy","datePublished": "2022-05-28T18:49:21+0000","mainEntityOfPage": {"@id": "https://blog.tatoglu.net/kendime-notlar/haproxy.html/#webpage"},"publisher": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"articleSection": ["notes"],"keywords": ["haproxy","load balancer","reverse proxy","keepalived","centos"],"inLanguage": ""},{"@type": ["Person"],"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034","name": "Fatih Tatoğlu","url": "https://blog.tatoglu.net/about-me.html","image": {"@type": "ImageObject","@id": "https://blog.tatoglu.net/#personlogo","inLanguage": "","url": "https://blog.tatoglu.net/image/about_me.jpg","contentUrl": "https://blog.tatoglu.net/image/about_me.jpg","width": 1024,"height": 683,"caption": "Fatih Tatoğlu"},"address": {"@type": "PostalAddress","addressLocality": "İstanbul","addressCountry": "Turkey"},"email": "fatih@tatoglu.net"}]}</script></head><body><header><span class="site-name">Fatih Tatoğlu</span></header><nav id="navigation"><span class="menu-button">▼</span><ul><li><a href="javascript:;">-</a><div class="sub-menu"><ul><li><a id="btnSetting" href="javascript:;">Tema Ayarları</a></li></ul></div></li><li><a href="https://blog.tatoglu.net/index.html">Anasayfa</a></li><li><a href="https://blog.tatoglu.net/kocluk/index.html">Koçluk</a></li><li><a href="https://blog.tatoglu.net/projeler/index.html">Projeler</a></li><li><a href="https://blog.tatoglu.net/kendime-notlar/index.html">Kendime Notlar</a></li><li><a href="https://blog.tatoglu.net/hakkimda.html">Hakkımda</a></li></ul></nav><main><article data-clarity-region="article"><header><h1>HAProxy</h1><button>#</button></header><p>Bu notumda CentOS 7.X üzerine cluster olacak şekilde HAProxy kurma notlarımı bulabilirsiniz. Kurulum kaynak kodlar üzerinden yapılacak şekildedir.</p><h2>Ortamların Hazırlanması</h2><p>Öncelikle yükleme yapacağımız ortamların hazırlanması gerekiyor. Kurulum için 2 tane CentOS makine ve 3 tane de IP adresi gerekiyor. Örnek kurulum için makine özellikleri aşağıdaki gibidir.</p><table><thead><tr><th align="center">Makine Adı</th><th align="center">IP Adresi</th><th align="center">CPU</th><th align="center">RAM</th><th align="center">Disk</th><th align="center">OS</th></tr></thead><tbody><tr><td align="center">haproxy-01</td><td align="center">192.168.160.2</td><td align="center">4</td><td align="center">2 GB</td><td align="center">40 GB</td><td align="center">CentOS 7.X Minimal</td></tr><tr><td align="center">haproxy-02</td><td align="center">192.168.160.3</td><td align="center">4</td><td align="center">2 GB</td><td align="center">40 GB</td><td align="center">CentOS 7.X Minimal</td></tr></tbody></table><p>192.168.160.4 IP adresi de 3. IP adresi olarak tanımlanmıştır. Makinelere root kullanıcısı ile erişildiği varsayılmaktadır.</p><p><code>root</code> ile işlem yapmamak için makinelere <code>devops</code> adında bir kullanıcı tanımlanıyor.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">
$ adduser devops</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">passwd devops</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">usermod -aG wheel devops</span>
</code></pre><p>Makineler clone olabilirler. Clone makinelerde <strong>machine-id</strong> aynı olacağı için ileride başımıza dert olabilir. Bunun için aşağıdaki komutlar ile <strong>machine-id</strong> değerini tekilleştirebiliriz.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">
$ <span class="hljs-built_in">cat</span> /etc/machine-id</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">rm</span> -f /etc/machine-id</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">systemd-machine-id-setup</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /etc/machine-id</span>
</code></pre><p>Makinelerde SELinux&#39;un kapatılması clusterın doğru çalışması için gereklilik olduğu için aşağıdaki kod ile kapatılabilir.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">
$ setenforce 0</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">sed -i <span class="hljs-string">&#x27;s/^SELINUX=.*/SELINUX=permissive/g&#x27;</span> /etc/selinux/config</span>
</code></pre><p>Bu işlemlerden sonra makine mutlaka restart edilmelidir.</p><h2>Gerekli Kullanıcıların Tanımlanması</h2><p>Güvenlik sebebiyle HAProxy ve cluster için kullanılacak Keep Alived için ayrı kullanıcılar açılmaktadır.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">groupadd -g 1985 haproxy</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">useradd -g 1985 -u 1985 -d /var/lib/haproxy -s /sbin/nologin -c haproxy haproxy</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">useradd -g <span class="hljs-built_in">users</span> -M keepalived_script</span>
</code></pre><h2>Gerekli Dosyaların İndirilmesi</h2><p>Yükleme yapılması için gereken kaynak kodların indirilmesi.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">curl https://www.lua.org/ftp/lua-5.4.4.tar.gz &gt; lua-5.4.4.tar.gz</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">curl http://www.haproxy.org/download/2.5/src/haproxy-2.5.7.tar.gz &gt; haproxy-2.5.7.tar.gz</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">curl https://www.keepalived.org/software/keepalived-2.2.7.tar.gz &gt; keepalived-2.2.7.tar.gz</span>
<span class="hljs-meta prompt_">
&gt; </span><span class="language-bash">tar xf lua-5.4.4.tar.gz</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">tar xf haproxy-2.5.7.tar.gz</span> 
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">tar xf keepalived-2.2.7.tar.gz</span>
</code></pre><h2>Gerekli Kütüphanelerin Kurulması</h2><p>Kaynak kodların derlenmesi için bazı kütüphanelerin yüklenmesi gerekmektedir.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">yum install gcc openssl-devel readline-devel systemd-devel make pcre-devel net-tools kernel-headers url libnl3-devel net-snmp-devel -y</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">yum update -y</span>
</code></pre><h2>Lua&#39;nın Derlenmesi</h2><p>Lua HAProxy içerisinde özelleştiş scriptler yazmak için kullanılabiliyor. İleride ihtiyaç olacağı için kuruluma dahil edildi.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> lua-5.4.4</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make INSTALL_TOP=/opt/lua-5.4.4 linux install</span>
</code></pre><h2>HAProxy&#39;nin Derlenmesi</h2><p>HAProxy kod üzerinden derlenirken Lua&#39;nın derlendiği yerin parametre olarak geçmesi gerekliliğinden dolayı ikinci sırada kurulmaktadır.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> haproxy-2.5.7</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make USE_NS=1 USE_TFO=1 USE_OPENSSL=1 USE_ZLIB=1 USE_LUA=1 USE_PCRE=1 USE_SYSTEMD=1 USE_LIBCRYPT=1 USE_THREAD=1 TARGET=linux-glibc LUA_INC=/opt/lua-5.4.4/include LUA_LIB=/opt/lua-5.4.4/lib</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make PREFIX=/opt/haproxy install</span>
</code></pre><h2>KeepAlived&#39;ın Derlenmesi</h2><p>HAProxy&#39;nin cluster olarak çalışması sağlayacak olan uygulamanın kurulumu.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> keepalived-2.2.7</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">./configure --prefix=/</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make install</span>
</code></pre><h2>Failover Scripti</h2><p>KeepAlived HAProxy&#39;nin çalışma durumuna göre iki makine arasında fail-over yapmaktadır. Ancak HAPrxoy uygulamasının çalıştığını anlaması için bir script ile kontrol etmesi gerekmektedir.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">vi /usr/local/bin/failover.sh</span>
</code></pre><pre><code class="hljs language-bash"><span class="hljs-meta">#!/bin/shell</span>
SERVICE=<span class="hljs-string">&#x27;haproxy&#x27;</span>
STATUS=$(ps ax | grep -v grep | grep <span class="hljs-variable">$SERVICE</span>)

<span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$STATUS</span>&quot;</span> != <span class="hljs-string">&quot;&quot;</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">
$ <span class="hljs-built_in">chmod</span> a+rx /usr/local/bin/failover.sh</span>
</code></pre><h2>HAProxy&#39;nin Konfigüre Edilmesi</h2><p>HAProxy&#39;nin doğru çalışabilmesi için doğru şekilde ayarlanması gerekmektedir. Kod üzerinden derleme yoluyla kurulum yapıldığı için de otomatik yapılan her şeyin manuel yapılması gerekmektedir.</p><h3>Servis Dosyası</h3><p>HAProxy&#39;nin servis dosyası oluşturulmalıdır. Bu sayede <code>systemctl</code> komutu ile kontrol edilebilir.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">vi /etc/systemd/system/haproxy.service</span>
</code></pre><pre><code class="hljs language-ini"><span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=HAProxy <span class="hljs-number">2.5</span>.<span class="hljs-number">7</span>
<span class="hljs-attr">After</span>=syslog.target network.target

<span class="hljs-section">[Service]</span>
<span class="hljs-attr">Type</span>=notify
<span class="hljs-attr">EnvironmentFile</span>=/etc/sysconfig/haproxy
<span class="hljs-attr">ExecStart</span>=/opt/haproxy/sbin/haproxy -f <span class="hljs-variable">$CONFIG_FILE</span> -p <span class="hljs-variable">$PID_FILE</span> <span class="hljs-variable">$CLI_OPTIONS</span>
<span class="hljs-attr">ExecReload</span>=/bin/kill -USR2 <span class="hljs-variable">$MAINPID</span>
<span class="hljs-attr">ExecStop</span>=/bin/kill -USR1 <span class="hljs-variable">$MAINPID</span>

<span class="hljs-section">[Install]</span>
<span class="hljs-attr">WantedBy</span>=multi-user.target
</code></pre><h3>Process Tanımı</h3><p>HAProxy çalışırken hangi parametrelerle çalışacağının belirlenmesi için process tanımı yapılmalıdır.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">vi /etc/sysconfig/haproxy</span>
</code></pre><pre><code class="hljs language-ini"><span class="hljs-comment"># Command line options to pass to HAProxy at startup</span>
<span class="hljs-comment"># The default is:</span>
<span class="hljs-attr">CLI_OPTIONS</span>=<span class="hljs-string">&quot;-Ws&quot;</span>

<span class="hljs-comment"># Specify an alternate configuration file. The default is:</span>
<span class="hljs-attr">CONFIG_FILE</span>=/etc/haproxy/haproxy.conf

<span class="hljs-comment"># File used to track process IDs. The default is:</span>
<span class="hljs-attr">PID_FILE</span>=/var/run/haproxy.pid
</code></pre><h3>HAProxy Konfigürasyonu</h3><p>HAProxy&#39;in hangi servisleri nereye yönlendireceği ile ilgili tanımların yapılması gerekmektedir.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> /etc/haproxy/</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> /etc/haproxy/errors</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> /etc/haproxy/certificates</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">vi /etc/haproxy/haproxy.conf</span>
</code></pre><pre><code class="hljs language-nestedtext"><span class="hljs-comment">##################################################</span>
<span class="hljs-comment">#                    Global                      #</span>
<span class="hljs-comment">##################################################</span>
global
    daemon
    maxconn     5000
    user        haproxy
    group       haproxy
    chroot      /var/lib/haproxy
    log 127.0.0.1 local0          #traffic logs
    log 127.0.0.1 local1 notice   #event logs

    <span class="hljs-comment">#SSL option</span>
    tune.ssl.default-dh-param 2048
    ssl-server-verify none
    ssl-default-bind-options no-sslv3

    <span class="hljs-comment">#Multithreading</span>
    nbproc 1
    nbthread 4
    cpu-map auto:1/1-4 0-3
<span class="hljs-comment">##################################################</span>


<span class="hljs-comment">##################################################</span>
<span class="hljs-comment">#                   Defaults                     #</span>
<span class="hljs-comment">##################################################</span>
defaults
    log global
    mode http
    option httplog
    option logasap
    timeout connect 4s
    timeout client 5s
    timeout server 86400s
    timeout http-request 30s
    timeout http-keep-alive 5s
    timeout queue 60s

    <span class="hljs-comment">#server defaults</span>
    default-server inter 1s rise 2 fall 4
    grace 3000

    <span class="hljs-comment">#request</span>
    option redispatch 1
    retries 2
<span class="hljs-comment">##################################################</span>


<span class="hljs-comment">##################################################</span>
<span class="hljs-comment">#                  Monitoring                    #</span>
<span class="hljs-comment">##################################################</span>
listen stats
    bind *:1985
    mode http
    stats enable
    stats uri /stats
    stats refresh 3s
    stats show-node
    option dontlog-normal
<span class="hljs-comment">##################################################</span>


<span class="hljs-comment">##################################################</span>
<span class="hljs-comment">#                    Frontend                    #</span>
<span class="hljs-comment">##################################################</span>

<span class="hljs-comment">##################################################</span>


<span class="hljs-comment">##################################################</span>
<span class="hljs-comment">#                    Backend                     #</span>
<span class="hljs-comment">##################################################</span>

<span class="hljs-comment">##################################################</span>


<span class="hljs-comment">##################################################</span>
<span class="hljs-comment">#                     Users                      #</span>
<span class="hljs-comment">##################################################</span>

<span class="hljs-comment">##################################################</span>
</code></pre><p>Konfigürasyonun doğrulanması için aşağıdaki kodun çalıştırılması yeterlidir.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">
$ /opt/haproxy/sbin/haproxy -c -V -f /etc/haproxy/haproxy.conf</span>
</code></pre><h3>Firewall Tanımları</h3><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">vi /etc/firewalld/services/haproxy.xml</span>
</code></pre><pre><code class="hljs language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">service</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">short</span>&gt;</span>HAProxy<span class="hljs-tag">&lt;/<span class="hljs-name">short</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>HAProxy load-balancer<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">port</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;tcp&quot;</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;80&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">port</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;tcp&quot;</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;443&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">port</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;tcp&quot;</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;1985&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>
</code></pre><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">
$ <span class="hljs-built_in">chmod</span> 640 /etc/firewalld/services/haproxy.xml</span>
</code></pre><h3>KeepAlived Konfigürasyonu</h3><p>KeepAlived makine bazında ayrı ayrı ayarlanması gerekmektedir.</p><h4>HAPROXY-01 Konfigürasyonu</h4><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">vi /etc/keepalived/keepalived.conf</span>
</code></pre><pre><code class="hljs language-roboconf">global_defs {
     <span class="hljs-attribute">enable_script_security
     smtp_server 127.0.0.1
     smtp_connect_timeout 30
     notification_email {
          fatih@tatoglu.net
     }
}

vrrp_script chk_haproxy {
     script &quot;/usr/local/bin/failover.sh&quot;
     interval 1
     weight 2
     rise 2
     fall 2
     init_fail
}

vrrp_instance VI_MASTER { 
    state MASTER 
    interface eth0
    virtual_router_id 51
    priority 101 
    advert_int 1
    virtual_ipaddress {
        192.168.160.4
    }
    track_script {
        chk_haproxy
    }
    smtp_alert true
}</span>
</code></pre><h4>HAPROXY-02 Konfigürasyonu</h4><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">vi /etc/keepalived/keepalived.conf</span>
</code></pre><pre><code class="hljs language-roboconf">global_defs {
     <span class="hljs-attribute">enable_script_security
     smtp_server 127.0.0.1
     smtp_connect_timeout 30
     notification_email {
          fatih@tatoglu.net
     }
}

vrrp_script chk_haproxy {
     script &quot;/usr/local/bin/failover.sh&quot;
     interval 1
     weight 2
     rise 2
     fall 2
     init_fail
}

vrrp_instance VI_BACKUP {
    state BACKUP 
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    virtual_ipaddress {
        192.168.160.4
    }
    track_script {
        chk_haproxy
    }
    smtp_alert true
}</span>
</code></pre><p>Aşağıdaki script ile KeepAlived konfigürasyonunu kontrol edebilirsiniz.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">
$ keepalived --config-test=keepalived.conf</span>
</code></pre><h3>Servislerin Etkinleştirilmesi ve Çalıştırılmaları</h3><p>Ayarlamalar yapıldığına göre artık çalıştırma zamanı.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">chkconfig keepalived on</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> firewalld</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl start firewalld</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">firewall-cmd --permanent --add-service=haproxy</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">firewall-cmd --add-rich-rule=<span class="hljs-string">&#x27;rule protocol value=&quot;vrrp&quot; accept&#x27;</span> --permanent</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">firewall-cmd --reload</span>
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> haproxy</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> keepalived</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start haproxy</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start keepalived</span>
</code></pre><h2>Test Edilmesi</h2><p>İki tane sistemi kurduk. Öncelikle sistemleri tek tek denememiz lazım. Bunun için;</p><ol><li><code>http://192.168.160.2:1985/stats</code></li><li><code>http://192.168.160.3:1985/stats</code></li></ol><p>adreslerini ziyaret edin. Karşınıza HAProxy&#39;nin statü sayfaları gelecektir. Sayfalarda makine isimlerinin doğru olduğuna emin olunmalı.</p><p>Sonrasında <code>http://192.168.160.4:1985/stats</code> adresi ziyaret edilir. KeepAlived haproxy-01 makinesi master olarak ayarlandığı için bu adres üzerinden haproxy-01 makinesindeki statü sayfasını geldiği doğrulanmalıdır.</p><p>Şimdi geldik fail-over testine. haproxy-01 makinesideki haproxy durulur.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl stop haproxy</span>
</code></pre><p>Sonrasında <code>http://192.168.160.4:1985/stats</code> adresi ziyaret edilir ve haproxy-02 makinesinin statü sayfasının geldiğin kontrol edilir.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">
$ systemctl start haproxy</span>
</code></pre><p>Yukarıdaki komut çalıştırılır ve haproxy-01 makinesinin statü sayfası geldiği kontrol edilir.</p><p>Test edilme sırasında her fail-over ve recovery olduğunda keepalived konfigürasyon dosyasında belirlenmiş mail adresine mail olarak bilgilendirme yapılır.</p><footer>By <a href="about-me.html" rel="noopener noreferrer" target="_blank">Fatih Tatoğlu</a> - <time pubdate datetime="2022-05-28T18:49:21+0000" title="28.05.2022">28.05.2022</time></footer></article></main><footer><span class="credits">Fatih Tatoğlu &copy; 1985</span></footer><div id="pnlSettingDialog" class="dialog"><div class="dialog-box"><div class="dialog-content"><header><button>■</button><span>Tema Ayarları</span></header><main><table style="margin: auto;"><thead><th style="width: 150px;">Renkler</th></thead><tbody><tr><td style="text-align: left; padding-left: 5%;"><input id="rbColoraqua" name="color" type="radio" value="aqua"> <label for="rbColoraqua">Aqua</label><br><input id="rbColorblack" name="color" type="radio" value="black"> <label for="rbColorblack">Black</label><br><input id="rbColorblue" name="color" type="radio" value="blue"> <label for="rbColorblue">Blue</label><br><input id="rbColorwhite" name="color" type="radio" value="white"> <label for="rbColorwhite">White</label></td></tr></tbody></table><br></main><footer><button id="btnSettingDialogOK" class="default" accesskey="t"><u>T</u>amam</button></footer></div></div></div></body></html>