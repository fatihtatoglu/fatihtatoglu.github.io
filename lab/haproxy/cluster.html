<!DOCTYPE html><html lang="tr"><head><base href="https://blog.tatoglu.net/"><meta charset="UTF-8"><meta name="yandex-verification" content="31a29a16b97b37a8"><meta name="msvalidate.01" content="578B5091D7C5A2C03BE2EE0DF0CCC024"><meta name="google-site-verification" content="7pv7CpUtN5qt6uIgrmkOjVK03wSJYs1vQKRiBESB978"><link rel="profile" href="https://gmpg.org/xfn/11"><meta name="description" content="HAProxy'nin yüksek erişilebilir yapısının kurulması ve test edilmesi."><meta name="author" content="Fatih Tatoğlu"><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap&v=d254415dcfdca7f7cdbe2c59784521eb" rel="stylesheet"><link rel="canonical" href="https://blog.tatoglu.net/lab/haproxy/cluster.html"><link rel="alternate" hreflang="x-default" href="https://blog.tatoglu.net/lab/haproxy/cluster.html"><link rel="alternate" hreflang="tr" href="https://blog.tatoglu.net/lab/haproxy/cluster.html"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fatih Tatoğlu - HAProxy - Cluster</title><link rel="stylesheet" href="https://blog.tatoglu.net/css/main.css?v=d254415dcfdca7f7cdbe2c59784521eb"><link rel="stylesheet" href="https://blog.tatoglu.net/css/custom.css?v=d254415dcfdca7f7cdbe2c59784521eb"><link rel="stylesheet" href="https://blog.tatoglu.net/css/3024.css?v=d254415dcfdca7f7cdbe2c59784521eb"><script src="https://blog.tatoglu.net/js/main.js?v=d254415dcfdca7f7cdbe2c59784521eb"></script><script src="https://blog.tatoglu.net/js/analytics.js?v=d254415dcfdca7f7cdbe2c59784521eb"></script><link rel="apple-touch-icon" sizes="180x180" href="https://blog.tatoglu.net/image/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://blog.tatoglu.net/image/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://blog.tatoglu.net/image/favicon/favicon-16x16.png"><link rel="manifest" href="https://blog.tatoglu.net/image/favicon/site.webmanifest"><link rel="icon" href="https://blog.tatoglu.net/favicon.ico" type="image/x-icon"><link rel="shortcut icon" href="https://blog.tatoglu.net/favicon.ico" type="image/x-icon"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@fatihtatoglu"><meta name="twitter:title" content="HAProxy - Cluster"><meta name="twitter:description" content="HAProxy'nin yüksek erişilebilir yapısının kurulması ve test edilmesi."><script type="application/ld+json">{"@context": "https://schema.org","@graph": [{"@type": "WebSite","@id": "https://blog.tatoglu.net/#website","url": "https://blog.tatoglu.net/","name": "Fatih Tatoğlu","description": "Fatih Tatoğlu - Kişisel Web Sayfası","publisher": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"inLanguage": ""},{"@type": "WebPage","@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#webpage","url": "https://blog.tatoglu.net/lab/haproxy/cluster.html","name": "HAProxy - Cluster - Fatih Tatoğlu","isPartOf": {"@id": "https://blog.tatoglu.net/#website"},"datePublished": "2022-06-12T18:41:00+0000","breadcrumb": {"@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#breadcrumb"},"inLanguage": "","potentialAction": [{"@type": "ReadAction","target": ["https://blog.tatoglu.net/lab/haproxy/cluster.html"]}]},{"@type": "BreadcrumbList","@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#breadcrumb","itemListElement": [{"@type": "ListItem","position": 1,"name": "Ana sayfa","item": "https://blog.tatoglu.net/"},{"@type": "ListItem","position": 2,"name": "HAProxy - Cluster"}]},{"@type": "Article","@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#article","isPartOf": {"@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#webpage"},"author": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"headline": "HAProxy - Cluster","datePublished": "2022-06-12T18:41:00+0000","mainEntityOfPage": {"@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#webpage"},"publisher": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"keywords": ["haproxy","keepalived","centos","failover","yüksek erişilebilirlilik","high availability"],"inLanguage": ""},{"@type": ["Person"],"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034","name": "Fatih Tatoğlu","url": "https://blog.tatoglu.net/about-me.html","image": {"@type": "ImageObject","@id": "https://blog.tatoglu.net/#personlogo","inLanguage": "","url": "https://blog.tatoglu.net/image/about_me.jpg","contentUrl": "https://blog.tatoglu.net/image/about_me.jpg","width": 1024,"height": 683,"caption": "Fatih Tatoğlu"},"address": {"@type": "PostalAddress","addressLocality": "İstanbul","addressCountry": "Turkey"},"email": "fatih@tatoglu.net"}]}</script></head><body><header><span class="site-name">Fatih Tatoğlu</span></header><nav id="navigation"><span class="menu-button">▼</span><ul><li><a href="javascript:;">-</a><div class="sub-menu"><ul><li><a id="btnSetting" href="javascript:;">Tema Ayarları</a></li></ul></div></li><li><a href="https://blog.tatoglu.net/index.html">Anasayfa</a></li><li><a href="https://blog.tatoglu.net/kocluk/index.html">Koçluk</a></li><li><a href="https://blog.tatoglu.net/projeler/index.html">Projeler</a></li><li><a href="https://blog.tatoglu.net/kendime-notlar/index.html">Kendime Notlar</a></li><li><a href="https://blog.tatoglu.net/lab/index.html">Laboratuvar</a></li><li><a href="https://blog.tatoglu.net/hakkimda.html">Hakkımda</a></li></ul></nav><main><article data-clarity-region="article"><header><h1>HAProxy - Cluster</h1><button>#</button></header><p>Bu notumda HAProxy için yüksek erişilebilir bir yapı kurulmasından bahsetmeye çalışacağım.</p><h2>Ortamların Hazırlanması</h2><p>Yüksek erişilebilir bir yapı kurmak için en az 2 makine ve 3 tane IP adresine ihtiyacımız bulunuyor.</p><table><thead><tr><th align="center">Makine Adı</th><th align="center">IP Adresi</th><th align="center">CPU</th><th align="center">RAM</th><th align="center">Disk</th><th align="center">OS</th></tr></thead><tbody><tr><td align="center">haproxy-01</td><td align="center">172.19.85.102</td><td align="center">4</td><td align="center">2 GB</td><td align="center">40 GB</td><td align="center">CentOS 7.X Minimal</td></tr><tr><td align="center">haproxy-02</td><td align="center">172.19.85.103</td><td align="center">4</td><td align="center">2 GB</td><td align="center">40 GB</td><td align="center">CentOS 7.X Minimal</td></tr></tbody></table><p><strong>172.19.85.104</strong> IP adresini 3. IP adresi olarak kullanılacak.</p><p>Makinlerin her birine <a href="./kendime-notlar/lab/haproxy/kurulum.html">HAProxy - Kurulum</a> adresindeki notlardan kurulumları yapılmalı.</p><h2>KeepAlived&#39;ın Yüklenmesi</h2><p>KeepAlived uygulaması iki makine arasında 3. IP adresini taşıyarak sistemin tek bir IP adresine üzerinden erişilebilir olmasını sağlayacaktır.</p><h3>Gerekli Dosyaların İndirilmesi</h3><p>Yükleme yapılması için gereken kaynak kodların indirilmesi.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">curl https://www.keepalived.org/software/keepalived-2.2.7.tar.gz &gt; keepalived-2.2.7.tar.gz</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">tar xf keepalived-2.2.7.tar.gz</span>
</code></pre><h3>KeepAlived&#39;ın Derlenmesi</h3><p>HAProxy&#39;nin cluster olarak çalışması sağlayacak olan uygulamanın kurulumu.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash"><span class="hljs-built_in">cd</span> ~</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo su</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash"><span class="hljs-built_in">cd</span> keepalived-2.2.7</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">./configure --prefix=/</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">make</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">make install</span>
</code></pre><h3>Failover Scripti</h3><p>KeepAlived HAProxy&#39;nin çalışma durumuna göre iki makine arasında fail-over yapmaktadır. Ancak HAProxy uygulamasının çalıştığını anlaması için bir script ile kontrol etmesi gerekmektedir.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo vi /usr/local/bin/failover.sh</span>
</code></pre><pre><code class="hljs language-bash"><span class="hljs-meta">#!/bin/shell</span>
SERVICE=<span class="hljs-string">&#x27;haproxy&#x27;</span>
STATUS=$(ps ax | grep -v grep | grep <span class="hljs-variable">$SERVICE</span>)

<span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$STATUS</span>&quot;</span> != <span class="hljs-string">&quot;&quot;</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo <span class="hljs-built_in">chmod</span> a+rx /usr/local/bin/failover.sh</span>
</code></pre><h3>Konfigürasyon</h3><p>KeepAlived makine bazında ayrı ayrı ayarlanması gerekmektedir.</p><h4>HAPROXY-01 Konfigürasyonu</h4><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo vi /etc/keepalived/keepalived.conf</span>
</code></pre><pre><code class="hljs language-roboconf">global_defs {
     <span class="hljs-attribute">enable_script_security
     smtp_server 127.0.0.1
     smtp_connect_timeout 30
     notification_email {
          fatih@tatoglu.net
     }
}

vrrp_script chk_haproxy {
     script &quot;/usr/local/bin/failover.sh&quot;
     interval 1
     weight 2
     rise 2
     fall 2
     init_fail
}

vrrp_instance VI_MASTER { 
    state MASTER 
    interface eth0
    virtual_router_id 51
    priority 101 
    advert_int 1
    virtual_ipaddress {
        172.19.85.104
    }
    track_script {
        chk_haproxy
    }
    smtp_alert true
}</span>
</code></pre><h4>HAPROXY-02 Konfigürasyonu</h4><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo vi /etc/keepalived/keepalived.conf</span>
</code></pre><pre><code class="hljs language-roboconf">global_defs {
     <span class="hljs-attribute">enable_script_security
     smtp_server 127.0.0.1
     smtp_connect_timeout 30
     notification_email {
          fatih@tatoglu.net
     }
}

vrrp_script chk_haproxy {
     script &quot;/usr/local/bin/failover.sh&quot;
     interval 1
     weight 2
     rise 2
     fall 2
     init_fail
}

vrrp_instance VI_BACKUP {
    state BACKUP 
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    virtual_ipaddress {
        172.19.85.104
    }
    track_script {
        chk_haproxy
    }
    smtp_alert true
}</span>
</code></pre><p>Aşağıdaki script ile KeepAlived konfigürasyonunu kontrol edebilirsiniz.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo keepalived --config-test=keepalived.conf</span>
</code></pre><h3>Servislerin Etkinleştirilmesi ve Çalıştırılmaları</h3><p>Ayarlamalar yapıldığına göre artık çalıştırma zamanı.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo chkconfig keepalived on</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> firewalld</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo systemctl start firewalld</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo firewall-cmd --add-rich-rule=<span class="hljs-string">&#x27;rule protocol value=&quot;vrrp&quot; accept&#x27;</span> --permanent</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo firewall-cmd --reload</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> keepalived</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo systemctl start keepalived</span>
</code></pre><h2>Test Edilmesi</h2><p>İki tane sistemi kurduk. Öncelikle sistemleri tek tek denememiz lazım. Bunun için;</p><ol><li><strong><code>http://172.19.85.102:1985/stats</code></strong></li><li><strong><code>http://172.19.85.103:1985/stats</code></strong></li></ol><p>adreslerini ziyaret edin. Karşınıza HAProxy&#39;nin statü sayfaları gelecektir. Sayfalarda makine isimlerinin doğru olduğuna emin olunmalı.</p><p>Sonrasında <strong><code>http://172.19.85.104:1985/stats</code></strong> adresi ziyaret edilir. KeepAlived haproxy-01 makinesi master olarak ayarlandığı için bu adres üzerinden haproxy-01 makinesindeki statü sayfasını geldiği doğrulanmalıdır.</p><p>Şimdi geldik fail-over testine. haproxy-01 makinesideki haproxy durulur.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo systemctl stop haproxy</span>
</code></pre><p>Sonrasında <strong><code>http://172.19.85.104:1985/stats</code></strong> adresi ziyaret edilir ve haproxy-02 makinesinin statü sayfasının geldiğin kontrol edilir.</p><pre><code class="hljs language-shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">sudo systemctl start haproxy</span>
</code></pre><p>Yukarıdaki komut çalıştırılır ve haproxy-01 makinesinin statü sayfası geldiği kontrol edilir.</p><p>Test edilme sırasında her fail-over ve recovery olduğunda keepalived konfigürasyon dosyasında belirlenmiş mail adresine mail olarak bilgilendirme yapılır.</p><footer>By <a href="about-me.html" rel="noopener noreferrer" target="_blank">Fatih Tatoğlu</a> - <time pubdate datetime="2022-06-12T18:41:00+0000" title="12.06.2022">12.06.2022</time></footer></article></main><footer><span class="credits">Fatih Tatoğlu &copy; 1985</span></footer><div id="pnlSettingDialog" class="dialog"><div class="dialog-box"><div class="dialog-content"><header><button>■</button><span>Tema Ayarları</span></header><main><table style="margin: auto;"><thead><th style="width: 150px;">Renkler</th></thead><tbody><tr><td style="text-align: left; padding-left: 5%;"><input id="rbColoraqua" name="color" type="radio" value="aqua"> <label for="rbColoraqua">Aqua</label><br><input id="rbColorblack" name="color" type="radio" value="black"> <label for="rbColorblack">Black</label><br><input id="rbColorblue" name="color" type="radio" value="blue"> <label for="rbColorblue">Blue</label><br><input id="rbColorwhite" name="color" type="radio" value="white"> <label for="rbColorwhite">White</label></td></tr></tbody></table><br></main><footer><button id="btnSettingDialogOK" class="default" accesskey="t"><u>T</u>amam</button></footer></div></div></div></body></html>