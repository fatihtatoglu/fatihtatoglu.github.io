<!DOCTYPE html><html lang="tr"><head><base href="https://blog.tatoglu.net/"><meta charset="UTF-8"><meta name="yandex-verification" content="31a29a16b97b37a8"><meta name="msvalidate.01" content="578B5091D7C5A2C03BE2EE0DF0CCC024"><meta name="google-site-verification" content="Ovuv1WWfkBGnFfpFHwwPPQSv274GrePTq1hq1Oq0Xc8"><link rel="profile" href="https://gmpg.org/xfn/11"><meta name="description" content="Verimli yük dengeleme için CentOS 7.X'te HAProxy'yi kurun. Hazırlık, kurulum, yapılandırma ve güvenlik için adım adım talimatları izleyin. Sorunsuz bir dağıtım sağlayın."><meta name="author" content="Fatih Tatoğlu"><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap&v=14eed7a09603467d0b26b870c8a8e771" rel="stylesheet"><link rel="canonical" href="https://blog.tatoglu.net/lab/haproxy/cluster.html"><link rel="alternate" hreflang="x-default" href="https://blog.tatoglu.net/lab/haproxy/cluster.html"><link rel="alternate" hreflang="tr" href="https://blog.tatoglu.net/lab/haproxy/cluster.html"><link rel="alternate" hreflang="en" href="https://blog.tatoglu.net/en/lab/haproxy/cluster.html"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fatih Tatoğlu - Cluster</title><link rel="stylesheet" href="https://blog.tatoglu.net/css/main.css?v=14eed7a09603467d0b26b870c8a8e771"><link rel="stylesheet" href="https://blog.tatoglu.net/css/custom.css?v=14eed7a09603467d0b26b870c8a8e771"><link rel="apple-touch-icon" sizes="180x180" href="https://blog.tatoglu.net/image/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://blog.tatoglu.net/image/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://blog.tatoglu.net/image/favicon/favicon-16x16.png"><link rel="manifest" href="https://blog.tatoglu.net/image/favicon/site.webmanifest"><link rel="icon" href="https://blog.tatoglu.net/favicon.ico" type="image/x-icon"><link rel="shortcut icon" href="https://blog.tatoglu.net/favicon.ico" type="image/x-icon"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@fatihtatoglu"><meta name="twitter:title" content="Cluster"><meta name="twitter:description" content="Verimli yük dengeleme için CentOS 7.X'te HAProxy'yi kurun. Hazırlık, kurulum, yapılandırma ve güvenlik için adım adım talimatları izleyin. Sorunsuz bir dağıtım sağlayın."><script type="application/ld+json">{"@context": "https://schema.org","@graph": [{"@type": "WebSite","@id": "https://blog.tatoglu.net/#website","url": "https://blog.tatoglu.net/","name": "Fatih Tatoğlu","description": "Fatih Tatoğlu - Kişisel Web Sayfası","publisher": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"inLanguage": ""},{"@type": "WebPage","@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#webpage","url": "https://blog.tatoglu.net/lab/haproxy/cluster.html","name": "Cluster - Fatih Tatoğlu","isPartOf": {"@id": "https://blog.tatoglu.net/#website"},"datePublished": "2022-06-12T18:41:00+0000","breadcrumb": {"@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#breadcrumb"},"inLanguage": "","potentialAction": [{"@type": "ReadAction","target": ["https://blog.tatoglu.net/lab/haproxy/cluster.html"]}]},{"@type": "BreadcrumbList","@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#breadcrumb","itemListElement": [{"@type": "ListItem","position": 1,"name": "Ana sayfa","item": "https://blog.tatoglu.net/"},{"@type": "ListItem","position": 2,"name": "Cluster"}]},{"@type": "Article","@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#article","isPartOf": {"@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#webpage"},"author": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"headline": "Cluster","datePublished": "2022-06-12T18:41:00+0000","mainEntityOfPage": {"@id": "https://blog.tatoglu.net/lab/haproxy/cluster.html/#webpage"},"publisher": {"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034"},"articleSection": ["lab"],"keywords": ["haproxy","keepalived","centos","failover","high availability"],"inLanguage": ""},{"@type": ["Person"],"@id": "https://blog.tatoglu.net//#/schema/person/9112274035621a3fbf80e30c19216034","name": "Fatih Tatoğlu","url": "https://blog.tatoglu.net/about-me.html","image": {"@type": "ImageObject","@id": "https://blog.tatoglu.net/#personlogo","inLanguage": "","url": "https://blog.tatoglu.net/image/about_me.jpg","contentUrl": "https://blog.tatoglu.net/image/about_me.jpg","width": 1024,"height": 683,"caption": "Fatih Tatoğlu"},"address": {"@type": "PostalAddress","addressLocality": "İstanbul","addressCountry": "Turkey"},"email": "fatih@tatoglu.net"}]}</script></head><body><header><h1 id="title">Cluster</h1><summary></summary></header><nav><i class="menu-icon">&#9776;</i><ul><li><a href="https://blog.tatoglu.net/index.html">Anasayfa</a></li><li><a href="https://blog.tatoglu.net/coaching/index.html">Koçluk</a></li><li><a href="https://blog.tatoglu.net/my-notes/index.html">Notlarım</a></li><li><a href="https://blog.tatoglu.net/lab/index.html">Laboratuvar</a></li><li><a href="https://blog.tatoglu.net/about-me.html">Hakkımda</a></li><li><button id="btnFeedback" class="icon" title="Geri Bildirim">&#128640;</button> <button id="btnDarkTheme" class="icon" title="Koyu Tema">&#127770;</button> <button id="btnLightTheme" class="icon" title="Açık Tema">&#127774;</button> <button id="btnEnglish" class="icon" title="İngilizce">🇺🇸</button></li></ul></nav><main><section><strong>HAProxy</strong><ul><li><a href=".&#x2F;lab&#x2F;haproxy&#x2F;setup.html">Kurulum</a></li><li class="active">Cluster</li><li><a href=".&#x2F;lab&#x2F;haproxy&#x2F;default-routing.html">Statik Yönlendirme</a></li><li><a href=".&#x2F;lab&#x2F;haproxy&#x2F;ssl-certificate.html">SSL Sertifika</a></li></ul></section><article><p>Bu not, iki HAProxy sunucusuna sahip bir cluster kurulumunu içerir.</p><p>🔥 Bu not KeepAlived 2.2.7 sürümü için yazılmıştır. Daha yeni sürümler farklı konfigürasyonlara sahip olabilir.</p><h2>Ön Hazırlık</h2><table><thead><tr><th align="right">Özellik</th><th align="left">Master Sunucu</th><th align="left">Slave Sunucu</th></tr></thead><tbody><tr><td align="right"><strong>Sunucu Adı</strong></td><td align="left">haproxy-01</td><td align="left">haproxy-02</td></tr><tr><td align="right"><strong>IP Adresi</strong></td><td align="left">172.19.85.102</td><td align="left">172.19.85.103</td></tr><tr><td align="right"><strong>Netmask</strong></td><td align="left">255.255.255.0</td><td align="left">255.255.255.0</td></tr><tr><td align="right"><strong>Gateway</strong></td><td align="left">172.19.85.1</td><td align="left">172.19.85.1</td></tr><tr><td align="right"><strong>CPU</strong> ⭐</td><td align="left">4</td><td align="left">4</td></tr><tr><td align="right"><strong>Bellek</strong> ⭐</td><td align="left">2 GB</td><td align="left">2 GB</td></tr><tr><td align="right"><strong>Disk</strong></td><td align="left">40GB</td><td align="left">40 GB</td></tr><tr><td align="right"><strong>OS</strong></td><td align="left">CentOS 7.X Minimal</td><td align="left">CentOS 7.X Minimal</td></tr><tr><td align="right"><strong>İnternet Erişimi</strong></td><td align="left">Evet</td><td align="left">Evet</td></tr></tbody></table><p>⭐: Kurulum işlemi sırasında kaynakları artırabilirsiniz.</p><p>Kurulum ve derleme sürecinde <strong>root</strong> kullanıcıya gerek yoktur. Ancak root ayrıcalıklarına sahip bir kullanıcıya ihtiyaç duyulacaktır. Notta <strong>devops</strong> kullanıcısı kurulum ve derleme süreci için kullanılır. Farklı bir kullanıcınız varsa lütfen onu kullanın.</p><p>Ayrıca clusterın master sunucuya hizmet verebilmesi için özel bir IP adresine ihtiyacı vardır. Dolayısıyla bu notta sanal IP adresi olarak <code>172.19.85.104</code> kullanılacaktır.</p><h2>Kurulum Hazırlığı</h2><p>Aşağıdaki dosya ilk sunucuya indirilmeli ve çıkartılmalıdır.</p><pre><code class="language-shell">devops@haproxy-01:~$ curl https://www.keepalived.org/software/keepalived-2.2.7.tar.gz &gt; keepalived-2.2.7.tar.gz

devops@haproxy-01:~$ tar xf keepalived-2.2.7.tar.gz
</code></pre><p>Aşağıdaki dosya ikinci sunucuya indirilmeli ve çıkartılmalıdır.</p><pre><code class="language-shell">devops@haproxy-02:~$ curl https://www.keepalived.org/software/keepalived-2.2.7.tar.gz &gt; keepalived-2.2.7.tar.gz

devops@haproxy-02:~$ tar xf keepalived-2.2.7.tar.gz
</code></pre><h2>Kurulum</h2><p>Derleme işlemi otomatiktir ve master ve slave sunucularda aşağıdaki komutların çalıştırılması gerekir.</p><pre><code class="language-shell">devops@haproxy-01:~$ cd ~
devops@haproxy-01:~$ sudo su
root@haproxy-01:/home/devops# 
root@haproxy-01:/home/devops# cd keepalived-2.2.7
root@haproxy-01:/home/devops# ./configure --prefix=/
root@haproxy-01:/home/devops# make
root@haproxy-01:/home/devops# make install
root@haproxy-01:/home/devops# exit
devops@haproxy-01:~$
</code></pre><pre><code class="language-shell">devops@haproxy-02:~$ cd ~
devops@haproxy-02:~$ sudo su
root@haproxy-02:/home/devops# 
root@haproxy-02:/home/devops# cd keepalived-2.2.7
root@haproxy-02:/home/devops# ./configure --prefix=/
root@haproxy-02:/home/devops# make
root@haproxy-02:/home/devops# make install
root@haproxy-02:/home/devops# exit
devops@haproxy-02:~$
</code></pre><h2>Konfigürasyon</h2><p>Yapılandırma bölümüne başlamadan önce KeepAlived kütüphanesinin çalışma tarzı anlaşılmalıdır. Kütüphane aynı anda master ve slave sunucuları dinler. Master sunucu sorunlarla karşılaşırsa, slave sunucu IP adresini sanal IP adresiyle günceller. Master sunucu tekrar canlı veya kullanılabilir hale geldiğinde kitaplık, master sunucunun IP adresini günceller. Bunu yapmak için kütüphanenin bir failover scriptine ihtiyacı vardır.</p><h3>Failover Script</h3><p>Failover script dosyası HAProxy hizmetinin durumunu kontrol eder. Komut dosyasının tüm sunuculara eklenmesi gerekir.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo vi /usr/local/bin/failover.sh
</code></pre><pre><code class="language-bash">#!/bin/shell
SERVICE=&#39;haproxy&#39;
STATUS=$(ps ax | grep -v grep | grep $SERVICE)

if [ &quot;$STATUS&quot; != &quot;&quot; ]
then
    exit 0
else
    exit 1
fi
</code></pre><p>KeepAlived kitaplığı root ayrıcalıklarıyla çalışır, bu nedenle failover script dosyasının ayrıcalıklarının güncellenmesi gerekir.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo chmod a+rx /usr/local/bin/failover.sh
</code></pre><p>Sunucuların yapılandırmasına devam edelim. Master ve slave sunucuların konfigürasyonları farklıdır. Aşağıda paylaşılmaktadır.</p><h3>Master Sunucu</h3><pre><code class="language-shell">devops@haproxy-01:~$ sudo vi /etc/keepalived/keepalived.conf
</code></pre><pre><code class="language-roboconf">global_defs {
     enable_script_security
     smtp_server 127.0.0.1
     smtp_connect_timeout 30
     notification_email {
          fatih@tatoglu.net
     }
}

vrrp_script chk_haproxy {
     script &quot;/usr/local/bin/failover.sh&quot;
     interval 1
     weight 2
     rise 2
     fall 2
     init_fail
}

vrrp_instance VI_MASTER { 
    state MASTER 
    interface eth0
    virtual_router_id 51
    priority 101 
    advert_int 1
    virtual_ipaddress {
        172.19.85.104
    }
    track_script {
        chk_haproxy
    }
    smtp_alert true
}
</code></pre><p>Doğrulamak için konfigürasyon dosyasını ekledikten sonra aşağıdaki komut kullanılabilir.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo keepalived --config-test=keepalived.conf
</code></pre><h3>Slave Sunucu</h3><pre><code class="language-shell">devops@haproxy-02:~$ sudo vi /etc/keepalived/keepalived.conf
</code></pre><pre><code class="language-roboconf">global_defs {
     enable_script_security
     smtp_server 127.0.0.1
     smtp_connect_timeout 30
     notification_email {
          fatih@tatoglu.net
     }
}

vrrp_script chk_haproxy {
     script &quot;/usr/local/bin/failover.sh&quot;
     interval 1
     weight 2
     rise 2
     fall 2
     init_fail
}

vrrp_instance VI_BACKUP {
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    virtual_ipaddress {
        172.19.85.104
    }
    track_script {
        chk_haproxy
    }
    smtp_alert true
}
</code></pre><p>Doğrulamak için konfigürasyon dosyasını ekledikten sonra aşağıdaki komut kullanılabilir.</p><pre><code class="language-shell">devops@haproxy-02:~$ sudo keepalived --config-test=keepalived.conf
</code></pre><h2>Güvenlik</h2><p>Hatırlarsanız zaten HAProxy için güvenlik duvarı ayarlanmıştı. Şimdi KeepAlived kütüphanesine izin vermek için aşağıdaki komut faydalı olacaktır.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo firewall-cmd --add-rich-rule=&#39;rule protocol value=&quot;vrrp&quot; accept&#39; --permanent
devops@haproxy-01:~$ sudo firewall-cmd --reload
</code></pre><pre><code class="language-shell">devops@haproxy-02:~$ sudo firewall-cmd --add-rich-rule=&#39;rule protocol value=&quot;vrrp&quot; accept&#39; --permanent
devops@haproxy-02:~$ sudo firewall-cmd --reload
</code></pre><h2>Çalıştırma</h2><pre><code class="language-shell">devops@haproxy-01:~$ sudo chkconfig keepalived on
devops@haproxy-01:~$ sudo systemctl enable keepalived
devops@haproxy-01:~$ sudo systemctl start keepalived
</code></pre><pre><code class="language-shell">devops@haproxy-02:~$ sudo chkconfig keepalived on
devops@haproxy-02:~$ sudo systemctl enable keepalived
devops@haproxy-02:~$ sudo systemctl start keepalived
</code></pre><h2>Doğrulama</h2><p>Öncelikle tüm sunucuların ayrı ayrı test edilmesi gerekmektedir. Bunun için;</p><ol><li><code>http://172.19.85.102:1985/stats</code></li><li><code>http://172.19.85.103:1985/stats</code></li></ol><p>yukarıdaki adresler tarayıcı üzerinden ziyaret edilmelidir. HAProxy hizmetlerinin durum sayfası gösterilmelidir.</p><p>Daha sonra tarayıcı üzerinden <code>http://172.19.85.104:1985/stats</code> adresine gidilmeli ve master sunucunun durum sayfası gösterilmelidir.</p><p>Şu ana kadar herhangi bir sorun yaşanmadıysa her şey yolunda görünüyor. Bir sonraki adımda HAProxy hizmet durumuyla oynayalım.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo systemctl stop haproxy
</code></pre><p>Yukarıdaki komutla master sunucudaki HAProxy hizmeti kapatılır. <code>http://172.19.85.104:1985/stats</code> adresini tekrar ziyaret ettikten sonra beklenen slave sunucunun durum sayfasının gösterilmesidir.</p><p>Son olarak aşağıdaki komut çalıştırıldığında her şey başlangıç durumunda olmalıdır.</p><pre><code class="language-shell">devops@haproxy-01:~$ sudo systemctl start haproxy
</code></pre><p>Bu arada, yapılandırma dosyalarını kontrol ederseniz bir e-posta adresi görebilirsiniz. Yani her yük devretme durumu değişikliğinden sonra bir e-posta alırsınız. Lütfen e-posta adresini güncellemeyi unutmayın. Aksi halde e-postam kilitlenebilir.</p></article></main><footer>&copy; 1985 - <a href="about-me.html" rel="noopener noreferrer" target="_blank">Fatih Tatoğlu</a></footer><script src="https://blog.tatoglu.net/js/main.js?v=14eed7a09603467d0b26b870c8a8e771"></script><script src="https://blog.tatoglu.net/js/analytics.js?v=14eed7a09603467d0b26b870c8a8e771"></script><div id="pnlFeedbackSurvey"><div class="model-content"><button id="btnFeedbackSurveyClose" class="icon bold x-small">&times;</button><iframe src="https://docs.google.com/forms/d/e/1FAIpQLSewJ_x10HBlFs2lO2zHUBI3ZeSdEXaISpK292RPJBoZyeC1HA/viewform?embedded=true" frameborder="0" marginheight="0" marginwidth="0">Loading…</iframe></div></div></body></html>